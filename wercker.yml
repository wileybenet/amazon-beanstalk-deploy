box: wercker/default
deploy:
  steps:
    - script:
        name: Install packages
        code: |-
          sudo apt-get update -qq
          sudo apt-get install unzip -qq
    - script:
        name: Install Beanstalk CLI
        code: |-
          wget --quiet https://s3.amazonaws.com/elasticbeanstalk/cli/AWS-ElasticBeanstalk-CLI-2.4.0.zip
          unzip -qq AWS-ElasticBeanstalk-CLI-2.4.0.zip
          sudo mkdir -p /usr/local/aws/elasticbeanstalk
          sudo mv AWS-ElasticBeanstalk-CLI-2.4.0/* /usr/local/aws/elasticbeanstalk/
          echo "PATH=/usr/local/aws/elasticbeanstalk/eb/linux/python2.7:$PATH" > ~/.bashrc
          echo "export AWS_CREDENTIAL_FILE=\"/home/ubuntu/.elasticbeanstalk/aws_credential_file\"" >> ~/.bashrc
          mkdir -p "/home/ubuntu/.elasticbeanstalk/"
          mkdir -p "$WERCKER_SOURCE_DIR/.elasticbeanstalk/"

          source ~/.bashrc
    - create-file:
        name: Create AWS credential file
        filename: $AWS_CREDENTIAL_FILE
        content: |-
            AWSAccessKeyId=$KEY
            AWSSecretKey=$SECRET_KEY
    - create-file:
        name: Add beanstalk config
        filename: $WERCKER_SOURCE_DIR/.elasticbeanstalk/config
        content: |-
          [global]
          ApplicationName=php-hello-world
          DevToolsEndpoint=git.elasticbeanstalk.us-east-1.amazonaws.com
          EnvironmentName=wercker
          Region=us-east-1
          ServiceEndpoint=https://elasticbeanstalk.us-east-1.amazonaws.com

          [branches]
          master=wercker

          [branch:master]
          ApplicationVersionName=master
          EnvironmentName=wercker
          InstanceProfileName=aws-elasticbeanstalk-ec2-role
    - script:
        name: Beanstalk there?
        code: eb status
    - script:
        name: Push it!
        code: |-
          git checkout master
          eb push
